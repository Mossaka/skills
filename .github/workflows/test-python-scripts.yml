name: Test Python Scripts

on:
  push:
    branches: [ main ]
    paths:
      - '**/*.py'
      - '.github/workflows/test-python-scripts.yml'
  pull_request:
    branches: [ main ]
    paths:
      - '**/*.py'
      - '.github/workflows/test-python-scripts.yml'
  workflow_dispatch:

jobs:
  test-scripts:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml

      - name: Syntax check all Python scripts
        run: |
          echo "ğŸ” Checking Python syntax for all scripts..."
          find . -name "*.py" -type f | while read file; do
            echo "Checking: $file"
            python -m py_compile "$file"
          done
          echo "âœ… All Python scripts have valid syntax"

      - name: Test skill-creator scripts
        run: |
          cd skill-creator/scripts

          echo "ğŸ“ Testing quick_validate.py..."
          # Test validation on an existing skill
          python quick_validate.py ../
          echo "âœ… quick_validate.py works"

          echo "ğŸ“ Testing init_skill.py..."
          # Create a temporary skill to test init
          temp_dir=$(mktemp -d)
          python init_skill.py test-skill --path "$temp_dir"
          # Verify the skill was created
          if [ -f "$temp_dir/test-skill/SKILL.md" ]; then
            echo "âœ… init_skill.py works"
          else
            echo "âŒ init_skill.py failed to create skill"
            exit 1
          fi
          rm -rf "$temp_dir"

          echo "ğŸ“ Testing package_skill.py..."
          # Create a test skill and package it
          temp_dir=$(mktemp -d)
          python init_skill.py test-package-skill --path "$temp_dir"
          python package_skill.py "$temp_dir/test-package-skill" "$temp_dir"
          # Verify the .skill file was created
          if [ -f "$temp_dir/test-package-skill.skill" ]; then
            echo "âœ… package_skill.py works"
          else
            echo "âŒ package_skill.py failed to create package"
            exit 1
          fi
          rm -rf "$temp_dir"

      - name: Test debug-workflow scripts
        run: |
          cd debug-workflow/scripts

          echo "ğŸ“ Testing quick_scan.py with mock data..."
          # Create mock log directory structure
          temp_dir=$(mktemp -d)
          mkdir -p "$temp_dir/mock-logs"
          echo "mcp:github:failed to connect" > "$temp_dir/mock-logs/agent-stdio.log"
          echo "dns error: Name does not resolve" >> "$temp_dir/mock-logs/agent-stdio.log"

          # Run quick_scan.py (it will report errors from our mock data)
          python quick_scan.py "$temp_dir/mock-logs" || true
          echo "âœ… quick_scan.py executes successfully"

          rm -rf "$temp_dir"

      - name: Test mcp-gateway scripts (without Docker)
        run: |
          cd mcp-gateway/scripts

          echo "ğŸ“ Testing setup-copilot.py..."
          # Test setup-copilot.py with mock environment
          export GATEWAY_PORT=8080
          export API_KEY=test-key-12345
          python setup-copilot.py

          # Verify config file was created
          if [ -f "/tmp/mcp-gateway-config.json" ]; then
            echo "âœ… setup-copilot.py works"
            cat /tmp/mcp-gateway-config.json
          else
            echo "âŒ setup-copilot.py failed to create config"
            exit 1
          fi

          echo ""
          echo "â­ï¸  Skipping Docker-dependent scripts:"
          echo "   - start-gateway.py (requires Docker, gh CLI, GitHub token)"
          echo "   - stop-gateway.py (requires Docker)"
          echo "   - debug-gateway.py (requires Docker)"
          echo "   These scripts are validated for syntax only."

      - name: Summary
        if: success()
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… All Python Script Tests Passed!"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Tested scripts:"
          echo "  âœ“ skill-creator/scripts/quick_validate.py"
          echo "  âœ“ skill-creator/scripts/init_skill.py"
          echo "  âœ“ skill-creator/scripts/package_skill.py"
          echo "  âœ“ debug-workflow/scripts/quick_scan.py"
          echo "  âœ“ mcp-gateway/scripts/setup-copilot.py"
          echo ""
          echo "Skipped (Docker/token required):"
          echo "  â­ï¸  mcp-gateway/scripts/start-gateway.py"
          echo "  â­ï¸  mcp-gateway/scripts/stop-gateway.py"
          echo "  â­ï¸  mcp-gateway/scripts/debug-gateway.py"
          echo ""
